include ../../../common.mk

CC_APP=/usr/bin/python3
CC_APP_CMDLINE=${CC_APP} -c 'print("SGX Encrypted Confidential Container Verify Integrity TEST PASSED !")'

CC_IMAGE_SIZE=128M

CC_IMAGE_INTEGRITY=sgxlkl-alpine-crypt-integrity.img
CC_IMAGE_INTEGRITY_KEY_FILE=$(CC_IMAGE_INTEGRITY).key

SGXLKL_ENV_INTEGRITY=\
SGXLKL_HD_KEY=${CC_IMAGE_INTEGRITY_KEY_FILE}\
SGXLKL_HD_RO=0

VERBOSE_OPTS=SGXLKL_VERBOSE=1 SGXLKL_KERNEL_VERBOSE=1

ifeq ($(SGXLKL_VERBOSE),)
	SGXLKL_ENV_INTEGRITY+=${VERBOSE_OPTS}
endif

.DELETE_ON_ERROR:
.PHONY: clean run-hw run-sw

clean:
	rm -f $(CC_IMAGE_INTEGRITY) $(CC_IMAGE_INTEGRITY_KEY_FILE)

$(CC_IMAGE_INTEGRITY):
	${SGXLKL_DISK_TOOL} create --size=${CC_IMAGE_SIZE} --encrypt --key-file --integrity --alpine="python3" ${CC_IMAGE_INTEGRITY}

run: run-hw

run-hw: $(CC_IMAGE_INTEGRITY)
	${SGXLKL_ENV_INTEGRITY} ${SGXLKL_STARTER} --hw-debug $(CC_IMAGE_INTEGRITY) $(CC_APP_CMDLINE)

run-sw: $(CC_IMAGE_INTEGRITY)
	${SGXLKL_ENV_INTEGRITY} ${SGXLKL_STARTER} --sw-debug $(CC_IMAGE_INTEGRITY) $(CC_APP_CMDLINE)
