
SGXLKL_ROOT=../../..

PROG=/usr/bin/iozone

BLK_TEST_APP_CONFIG_TEMPLATE=sgxlkl-encrypted-config-template.json
BLK_TEST_APP_CONFIG=sgxlkl-virtio-blk-test-config.json

BLK_TEST_ENCRYPTED_IMAGE_SIZE=128M
BLK_TEST_PLAIN_IMAGE_SIZE=1G

BLK_TEST_PLAIN_IMAGE=sgxlkl-plain.img
BLK_TEST_ENCRYPTED_DATA=data-dm-crypt.img
BLK_TEST_ENCRYPTED_IMAGE=sgxlkl-dm-crypt.img
BLK_TEST_ENCRYPTED_IMAGE_KEY_FILE=$(BLK_TEST_ENCRYPTED_IMAGE).key

SGXLKL_ENV_APP_CONFIG=\
SGXLKL_HDS=${BLK_TEST_ENCRYPTED_DATA}:/data:0

SGXLKL_STARTER=$(SGXLKL_ROOT)/build/sgx-lkl-run-oe
SGXLKL_DISK_TOOL=${SGXLKL_ROOT}/tools/sgx-lkl-disk

SGXLKL_ENV_OPTS=SGXLKL_GETTIME_VDSO=0
VERBOSE_OPTS=SGXLKL_VERBOSE=1 SGXLKL_KERNEL_VERBOSE=1

ifeq ($(SGXLKL_VERBOSE),)
	SGXLKL_ENV_APP_CONFIG+=${VERBOSE_OPTS}
endif
SGXLKL_ENV_APP_CONFIG+=${SGXLKL_ENV_OPTS}
SGXLKL_ENV=${VERBOSE_OPTS} ${SGXLKL_ENV_OPTS}

.DELETE_ON_ERROR:
.PHONY: all clean hw-run-enc-test sw-run-enc-test hw-run-plain-test sw-run-plain-test

all: ${BLK_TEST_APP_CONFIG} ${BLK_TEST_PLAIN_IMAGE}

clean:
	@rm -f $(BLK_TEST_ENCRYPTED_IMAGE) $(BLK_TEST_ENCRYPTED_IMAGE_KEY_FILE) ${BLK_TEST_ENCRYPTED_DATA} 
	@rm -f ${BLK_TEST_PLAIN_IMAGE}
	@rm -f ${BLK_TEST_APP_CONFIG}

$(BLK_TEST_ENCRYPTED_IMAGE):
	@rm -f ${BLK_TEST_ENCRYPTED_IMAGE}
	${SGXLKL_DISK_TOOL} create --size=${BLK_TEST_ENCRYPTED_IMAGE_SIZE} --encrypt --key-file --integrity --docker="./Dockerfile" ${BLK_TEST_ENCRYPTED_IMAGE}

$(BLK_TEST_PLAIN_IMAGE):
	@rm -f $(BLK_TEST_PLAIN_IMAGE)
	${SGXLKL_DISK_TOOL} create --size=${BLK_TEST_PLAIN_IMAGE_SIZE} --docker="./Dockerfile" ${BLK_TEST_PLAIN_IMAGE}

${BLK_TEST_APP_CONFIG}: $(BLK_TEST_ENCRYPTED_IMAGE)
	@cp ${BLK_TEST_ENCRYPTED_IMAGE} ${BLK_TEST_ENCRYPTED_DATA}
	cp ${BLK_TEST_APP_CONFIG_TEMPLATE} ${BLK_TEST_APP_CONFIG}
	$(eval CC_IMAGE_INTEGRITY_KEY=$(shell xxd -ps -c100 ${BLK_TEST_ENCRYPTED_IMAGE_KEY_FILE}))
	sed -i "/\"key\":/c\\"\"key\"": \"${CC_IMAGE_INTEGRITY_KEY}\"" ${BLK_TEST_APP_CONFIG}

hw-run-enc-test: ${BLK_TEST_APP_CONFIG}
	${SGXLKL_ENV_APP_CONFIG} ${SGXLKL_STARTER} --app-config=${BLK_TEST_APP_CONFIG} --hw-debug $(BLK_TEST_ENCRYPTED_IMAGE) $(PROG) -a

sw-run-enc-test: ${BLK_TEST_APP_CONFIG}
	${SGXLKL_ENV_APP_CONFIG} ${SGXLKL_STARTER} --app-config=${BLK_TEST_APP_CONFIG} --sw-debug $(BLK_TEST_ENCRYPTED_IMAGE) $(PROG) -a

hw-run-plain-test: ${BLK_TEST_PLAIN_IMAGE}
	${SGXLKL_ENV} ${SGXLKL_STARTER} --hw-debug $(BLK_TEST_PLAIN_IMAGE) $(PROG) -a

sw-run-plain-test: ${BLK_TEST_PLAIN_IMAGE}
	${SGXLKL_ENV} ${SGXLKL_STARTER} --sw-debug $(BLK_TEST_PLAIN_IMAGE) $(PROG) -a

show-commands:
	@echo "[ hw-run-enc-test sw-run-enc-test hw-run-plain-test sw-run-plain-test ]"
