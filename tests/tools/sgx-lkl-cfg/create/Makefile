include ../../../common.mk

PROG_SRC=src/app.py
IMAGE_SIZE=100M

SGXLKL_ENV=SGXLKL_VERBOSE=1 SGXLKL_KERNEL_VERBOSE=1
SGXLKL_HW_PARAMS=--hw-debug
SGXLKL_SW_PARAMS=--sw-debug

SGXLKL_ROOTFS=rootfs.img
SGXLKL_DATAFS=datafs.img
SGXLKL_HOST_CFG=host-config.json.tmp
SGXLKL_HOST_CFG_COMPLETE=host-config-complete.json.tmp
SGXLKL_ENCLAVE_CFG=enclave-config.json.tmp
SGXLKL_ENCLAVE_CFG_REF=enclave-config-ref.json
SGXLKL_ENCLAVE_CFG_COMPLETE=enclave-config-complete.json.tmp
SGXLKL_ENCLAVE_CFG_COMPLETE_REF=enclave-config-complete-ref.json
SGXLKL_COMMON_PARAMS=--host-config=$(SGXLKL_HOST_CFG) --app-config=$(SGXLKL_ENCLAVE_CFG)
SGXLKL_COMMON_PARAMS_COMPLETE=--host-config=$(SGXLKL_HOST_CFG_COMPLETE) --app-config=$(SGXLKL_ENCLAVE_CFG_COMPLETE)
VALID_STAMP=valid.stamp.tmp

.DELETE_ON_ERROR:
.PHONY: all clean

$(SGXLKL_ROOTFS): $(PROG_SRC)
	${SGXLKL_DISK_TOOL} create --size=${IMAGE_SIZE} --docker=./Dockerfile ${SGXLKL_ROOTFS}

$(SGXLKL_DATAFS): $(SGXLKL_ROOTFS)
	cp $(SGXLKL_ROOTFS) $(SGXLKL_DATAFS)

$(SGXLKL_HOST_CFG) $(SGXLKL_ENCLAVE_CFG): $(SGXLKL_ROOTFS) $(SGXLKL_DATAFS)
	${SGXLKL_CFG_TOOL} create \
	  --disk ${SGXLKL_ROOTFS} $(SGXLKL_DATAFS) \
	  --host-cfg $(SGXLKL_HOST_CFG) --app-cfg $(SGXLKL_ENCLAVE_CFG)

$(SGXLKL_HOST_CFG_COMPLETE) $(SGXLKL_ENCLAVE_CFG_COMPLETE): $(SGXLKL_ROOTFS) $(SGXLKL_DATAFS)
	${SGXLKL_CFG_TOOL} create \
	  --disk ${SGXLKL_ROOTFS} $(SGXLKL_DATAFS) \
	  --host-cfg $(SGXLKL_HOST_CFG_COMPLETE) --app-cfg $(SGXLKL_ENCLAVE_CFG_COMPLETE) \
	  --complete

$(VALID_STAMP): $(SGXLKL_HOST_CFG) $(SGXLKL_ENCLAVE_CFG) $(SGXLKL_HOST_CFG_COMPLETE) $(SGXLKL_ENCLAVE_CFG_COMPLETE)
	${SGXLKL_CFG_TOOL} validate \
	  --host-cfg $(SGXLKL_HOST_CFG_COMPLETE) --app-cfg $(SGXLKL_ENCLAVE_CFG_COMPLETE)
	${SGXLKL_CFG_TOOL} validate \
	  --host-cfg $(SGXLKL_HOST_CFG) --app-cfg $(SGXLKL_ENCLAVE_CFG)
	@echo "NOTE: Run 'make update-ref-cfg' to update the reference files if the following fails."
	diff $(SGXLKL_ENCLAVE_CFG_COMPLETE) $(SGXLKL_ENCLAVE_CFG_COMPLETE_REF)
	diff $(SGXLKL_ENCLAVE_CFG) $(SGXLKL_ENCLAVE_CFG_REF)
	@touch $(VALID_STAMP)

update-ref-cfg: $(SGXLKL_HOST_CFG) $(SGXLKL_ENCLAVE_CFG) $(SGXLKL_HOST_CFG_COMPLETE) $(SGXLKL_ENCLAVE_CFG_COMPLETE)
	cp $(SGXLKL_ENCLAVE_CFG) $(SGXLKL_ENCLAVE_CFG_REF)
	cp $(SGXLKL_ENCLAVE_CFG_COMPLETE) $(SGXLKL_ENCLAVE_CFG_COMPLETE_REF)

run: run-hw run-sw
run-hw: run-hw-default run-hw-complete
run-sw: run-sw-default run-sw-complete

run-hw-default: $(VALID_STAMP)
	  $(SGXLKL_ENV) $(SGXLKL_STARTER) $(SGXLKL_HW_PARAMS) $(SGXLKL_COMMON_PARAMS)

run-sw-default: $(VALID_STAMP)
	  $(SGXLKL_ENV) $(SGXLKL_STARTER) $(SGXLKL_SW_PARAMS) $(SGXLKL_COMMON_PARAMS)

run-hw-complete: $(VALID_STAMP)
	  $(SGXLKL_ENV) $(SGXLKL_STARTER) $(SGXLKL_HW_PARAMS) $(SGXLKL_COMMON_PARAMS_COMPLETE)

run-sw-complete: $(VALID_STAMP)
	  $(SGXLKL_ENV) $(SGXLKL_STARTER) $(SGXLKL_SW_PARAMS) $(SGXLKL_COMMON_PARAMS_COMPLETE)

clean:
	rm -f $(SGXLKL_ROOTFS) $(SGXLKL_DATAFS) \
	  $(SGXLKL_HOST_CFG) $(SGXLKL_ENCLAVE_CFG) \
	  $(SGXLKL_HOST_CFG_COMPLETE) $(SGXLKL_ENCLAVE_CFG_COMPLETE) \
	  $(VALID_STAMP)
